# Supervisor Modbus ğŸš€

Sistema de monitoramento industrial de alta performance desenvolvido em Python, focado na coleta, bufferizaÃ§Ã£o e persistÃªncia de dados provenientes de redes Modbus (TCP/RTU).

Este projeto foi desenhado para suportar cargas crÃ­ticas de escrita, processando mais de **2.400 operaÃ§Ãµes de inserÃ§Ã£o (PUTs) por minuto** de forma estÃ¡vel e com baixo consumo de recursos.

---

## ğŸ› ï¸ Tecnologias Utilizadas

- **Linguagem:** Python 3.12+
- **ConcorrÃªncia:** `asyncio` (Event Loop para I/O nÃ£o-bloqueante)
- **Banco de Dados:** PostgreSQL
- **Driver DB:** `asyncpg` (Alta performance via protocolo binÃ¡rio)
- **Gerenciamento de Pacotes:** Poetry
- **ConfiguraÃ§Ãµes:** Pydantic Settings (GestÃ£o de `.env`)

---

## ğŸ—ï¸ Arquitetura e Performance

O sistema utiliza o padrÃ£o **Produtor-Consumidor** otimizado para evitar gargalos de rede:

1.  **Reader (Produtor):** Realiza leituras assÃ­ncronas na rede Modbus e alimenta um buffer central.
2.  **Buffer (Core):** Uma fila assÃ­ncrona (`asyncio.Queue`) que implementa _backpressure_, protegendo a memÃ³ria do sistema caso o banco de dados oscile.
3.  **Worker (Consumidor):** Agrupa os dados em lotes (batches) e utiliza o mÃ©todo `executemany` do `asyncpg`, reduzindo drasticamente o overhead de rede.
4.  **Connection Pooling:** Reutiliza conexÃµes abertas com o PostgreSQL, eliminando a latÃªncia de novos handshakes TCP.

<img src="./docs/workflow.png" alt="workflow">

## ğŸ“‚ Estrutura do Projeto

```text
â”œâ”€src/
|  â”œâ”€â”€ core/                  # LÃ³gica central (Buffer, ConfiguraÃ§Ãµes, Logger)
|  |    â”œâ”€â”€ types/            # DefiniÃ§Ã£o de payloads
|  |    â”œâ”€â”€ buffer.py
|  |    â”œâ”€â”€ config.py
|  |    â”œâ”€â”€ monitor.py
|  |    â””â”€â”€ logger.py
|  â”œâ”€â”€ infrastructure/        # Infraestrutura (Modbus Reader, Database Repository)
|  |    â”œâ”€â”€ database/
|  |    |      â”œâ”€â”€ connection.py
|  |    |      â””â”€â”€ repositories.py
|  |    â””â”€â”€ CW.py             # Modbus reader
|  â”œâ”€â”€ services/              # OrquestraÃ§Ã£o (Workers e fluxo de dados)
|  |     â””â”€â”€ worker.py
|  â”œâ”€â”€ api/                   # DefiniÃ§Ãµes de payloads e contratos de dados
|  |    â”œâ”€â”€ __init__.py
|  |    â””â”€â”€ routes.py         # DefiniÃ§Ã£o das rotas de api
|  â””â”€â”€ utils/                 # UtilitÃ¡rios (Superclasse EventManager, conversores)
|       â”œâ”€â”€ date.py
|       â””â”€â”€ event_manager.py
â”œâ”€â”€ run.py                    # Entrypoint da aplicaÃ§Ã£o
â”œâ”€â”€ api.py                    # Entrypoint da api
â””â”€â”€ main.py                   # Entrypoint do servico
```

---

## ğŸš€ Como Executar

### PrÃ©-requisitos

- Python 3.12+
- Poetry instalado
- InstÃ¢ncia de PostgreSQL ativa

### InstalaÃ§Ã£o

1. **Clone o repositÃ³rio:**

   ```bash
   git clone [https://github.com/ricardoracki/supervisor_modbus.git](https://github.com/ricardoracki/supervisor_modbus.git)
   cd supervisor_modbus
   ```

2. **Instale as dependÃªncias:**

   ```bash
   poetry install
   ```

3. **ConfiguraÃ§Ã£o do Ambiente:** Crie um arquivo .env (ou local.env) na raiz do projeto conforme o exemplo:

```
DATABASE_URL=postgresql://usuario:senha@localhost:5432/nome_do_banco
```

4. **ExecuÃ§Ã£o:**:

```
poetry run python src/main.py
```

## ğŸ“Š RepositÃ³rio e Consultas

O `PesagemRepository` oferece mÃ©todos otimizados para consultas histÃ³ricas e anÃ¡lise de dados em tempo real:

- **Filtros DinÃ¢micos:** Suporte para busca por `maquina_id`, `data_pesagem` ou `classificacao`.
- **Placeholder Management:** Uso de placeholders numerados (`$1`, `$2`) para prevenir SQL Injection e permitir que o PostgreSQL otimize os planos de execuÃ§Ã£o.
- **OtimizaÃ§Ã£o de Query:** Utiliza Ã­ndices temporais e limites de busca (`LIMIT 1000`) para garantir que o sistema permaneÃ§a performÃ¡tico mesmo apÃ³s meses de operaÃ§Ã£o e milhÃµes de registros acumulados.

---

## ğŸ“„ LicenÃ§a

Este projeto estÃ¡ sob a licenÃ§a MIT. Consulte o arquivo [LICENSE](LICENSE) para mais detalhes.

---

**Desenvolvido por [Ricardo Racki](https://github.com/ricardoracki)**
